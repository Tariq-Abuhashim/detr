
(1) Deactivate anaconda:
$ conda deactivate

(2) Install Ansible:
$ sudo apt install ansible
$ ansible --version
ansible 2.9.6
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/home/dv/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3/dist-packages/ansible
  executable location = /usr/bin/ansible
  python version = 3.8.10 (default, Nov 22 2023, 10:22:35) [GCC 9.4.0]
  
(3) Install Docker (docker compose):
$ git clone git@gitlab.com:missionsystems/installers.git
$ cd installers
$ ./install.sh --install-role=docker
$ docker compose version
Docker Compose version v2.27.0

(4) Add docker to groups, first check if its already there:
$ groups
$ sudo groupadd docker
$ reboot
$ groups

(5) Run UTS docker image:
$ docker login registry.gitlab.com
$ git clone https://gitlab.com/forv/deployment/docker-deployment.git
$ cd docker-deployment/

# multi-platform pull
$ FORV_REGISTRY=registry.gitlab.com/forv/deployment/docker-deployment docker compose -f FORV2/simulation_services.yaml pull arena_camera_debug

# AMD64 pull
$ docker pull --platform=linux/amd64 registry.gitlab.com/forv/deployment/docker-deployment/camera-ros:humble

# ARM64 pull
$ docker pull --platform=linux/arm64 registry.gitlab.com/forv/deployment/docker-deployment/camera-ros:humble

$ FORV_REGISTRY=registry.gitlab.com/forv/deployment/docker-deployment docker compose -f FORV2/simulation_services.yaml up arena_camera_debug

(6) Work with the docker image in another terminal:
$ docker container ls
$ docker exec -it arena_camera_debug bash
$ source /opt/ros/humble/setup.bash
$ ros2 topic lits


(***)
$ cd docker-deployment
$ FORV_REGISTRY=registry.gitlab.com/forv/deployment/docker-deployment docker compose -f Morse/image_detection_bringup.yaml pull arena_camera_continuous image_tools rqt_gui
$ FORV_REGISTRY=registry.gitlab.com/forv/deployment/docker-deployment docker compose -f Morse/image_detection_bringup.yaml up image_detection_bringup

You can now use some of the debug tools. What I've been doing is:

	- Start the rqt_gui service: 
		$ FORV_REGISTRY=registry.gitlab.com/forv/deployment/docker-deployment docker compose -f Morse/image_detection_bringup.yaml up rqt_gui

	- Using the menus at the top, add a dynamic_reconfigure widget on the left and image_view widget on the right. 
		You'll end up with something like the attached image

	- You can now change the debug_filename to something else (eg. debug02) and you'll see the image on the right change

To use the trigger service version instead, start the image_detection_trigger_bringup service in the compose instead

	- You can call the service from a native ROS2 install, or from within another container.

		Either docker exec into one of the containers you've just started, or start a new one with 
			$ docker compose -f Morse/image_detection_bringup.yaml run --rm rqt_gui bash
    	Source and set ROS_DOMAIN_ID 
			$ source /opt/ros/humble/setup.bash && export ROS_DOMAIN_ID=10
    	Call the service with 
			$ ros2 service call /arena_camera_node/trigger_image std_srvs/srv/Trigger {}

	- For some reason it seems like the first time the trigger is called nothing is sent, but it's fine from then on. I'll look into that


Working with Mission-Systems docker container:

$ docker login
username is: devopsmisssys
password is: lordofthebytes
$ docker pull missionsystems/base:20.04-ros2-cuda-devel

$ sudo apt install nvidia-container-toolkit

On your laptop run:

$ docker run \
    -it \
    --gpus all \
    -e DISPLAY=$DISPLAY \
    -e NVIDIA_DRIVER_CAPABILITIES=graphics,compute,utility,display \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    missionsystems/base:20.04-ros2-cuda-devel "bash"

On the Jetson, RUN:

$ docker run \
    -it \
    --runtime nvidia \
    -e DISPLAY=$DISPLAY \
    -e NVIDIA_DRIVER_CAPABILITIES=graphics,compute,utility,display \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    missionsystems/base:20.04-ros2-cuda-devel "bash"


DETR image name is (use "docker image ls")
missionsystems/detr-devel-amd64


How to delete an image and a container?

Stop All Running Containers:
$ docker stop $(docker ps -q)

Remove All Containers:
$ docker rm $(docker ps -a -q)

Remove the Docker Image:
$ docker rmi missionsystems/base:20.04-ros2-cuda-devel

Force Remove the Docker Image (if necessary):
$ docker rmi -f missionsystems/base:20.04-ros2-cuda-devel

Remove Dangling Images:
$ docker image prune

Remove Unused Images and Other Resources:
$ docker system prune -a
